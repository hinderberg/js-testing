<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://github.com/downloads/gnab/remark/remark-0.3.4.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://github.com/downloads/kjbekkelund/remark-bekk/bekk-0.0.3.js" type="text/javascript"></script>
    <link href="https://github.com/downloads/kjbekkelund/remark-bekk/bekk-0.0.3.css" type="text/css" rel="stylesheet">
    <style type="text/css" media="screen">
      #slideshow .slide .content.front-page h1 { width: 100%; }
      .slide p { padding: 0; margin: 1.1em 0; }
      .slide ul { padding: 0; margin: 1.1em 0; }
      .slide img { max-width: 100%; max-height: 600px; }
      #slideshow .slide .content ul li { padding-left: 1.3em; }
    </style>
  </head>
  <body>
    <textarea id="source">

.front-page

# Testing av JavaScript

## Testing og arkitektur

Kurs

Kim Joar Bekkelund og Tine Kleivane

29/05/2012

---

.agenda

# Agenda

* En agenda

---

# Utbytte

Se reelle eksempler på testing av JavaScript

* Både gode og dårlige måter
* Diskutere virkningene av denne typen testing

Et forslag til abstraksjoner og en JavaScript-arkitektur

* Struktur å måle både andre rammeverk og egne applikasjoner mot

---

# Utbytte

Vi skal lære å *ikke* skrive kode som dette:

    .javascript
    jQuery(function() {
      $(".user form").submit(function(e) {
        e.preventDefault();
        $.ajax({
          // ...
          success: function(data) {
            var name = data.name ? data.name : "Unknown";
            $(".user .info").append("<h1>" + name + "</h1>");
          }
        });
      });
    }

Dette er komplekst! Blant annet:

* Lytter på at siden er klar
* Lytter på submit
* Håndterer nettverkskall
* Parser respons
* Templating

---

.middle.center

Men først …

---

# Intro til Jasmine

    .javascript
    // Gruppering av specs
    describe("My tests", function(){
      // Kjører før hver test
      beforeEach(function(){
        this.color = "green";
      });

      // Kjører etter hver test
      afterEach(function(){
        this.color = "green";
      });

      // Selve testen
      it("looks green", function(){
        expect(this.color).toEqual("green");
        // Finnes mange matchere, blant annet:
        // `toBe`, `toMatch`, `toBeDefined`, `toBeTruthy`, `toContain`, osv
      });
    });

* BDD-rammeverk - vi beskriver oppførsel
* Kan kjøre standalone eller som en del av maven
* Kan kjøre asynkrone kall med `runs` og `waits`
* Brukes på flere BEKK-prosjekter

---

.pushed

![](images/monolog_cropped.png)

# Målet

Lage en superenkel Twitter-lignende applikasjon: *Monolog*

---

.middle.center

# Views

---

# Views

* Et view eier et DOM-element, som vi vil kalle `el`.
* Vi sender alltid med `el` når vi lager et view
* Det er kun views som har lov til å røre DOM-en!

---

# Views

Vi skal benytte et enkelt rammeverk: Simple.js

* http://kjbekkelund.github.com/simple/

Hvordan lage et nytt view:

    .javascript
    var UserView = Simple.View.extend({

      // Vi kan legge til instansmetoder.
      // I disse metodene har vi `this` tilgjengelig.

      initialize: function(options) {
        // Kjøres automatisk når et view initialiseres
        // Tar imot et argument, en options-hash
      },

      showUserInfo: function(){
        // View-logikk og rendering
      };
    });

    // Lager en instans (og sender med `el`)
    var view = new UserView({ el: $(".user") });
    view.showUserInfo();

---

.middle.center

# Setup

All kode ligger på [https://github.com/kjbekkelund/js-tdd-kurs](https://github.com/kjbekkelund/js-tdd-kurs)

---

# Oppgave 1

Vi starter enkelt:

    .javascript
    describe("The user view", function() {
      it("should have a user when initialized", function() {
        var user = {};

        // Initialize a new view

        expect(view.user).toBeDefined();
      });
    });

---

# Gjennomgang oppgave

Test:

    .javascript
    it("should have a user when initialized", function() {
      var user = {};

      var view = new BEKK.UserView({ user: user });

      expect(view.user).toBeDefined();
    });

Kode:

    .javascript
    BEKK.UserView = Simple.View.extend({
      initialize: function(options) {
        this.user = options.user;
      }
    });

---

# View-rendring

Et view eier et element, `el`.

`template` inneholder ren HTML som skal inn i viewet.

Det er `render` sitt ansvar er å interpolere data i template og plassere dette
i `el`.

… men å rendre `el` til DOM-en er *ikke* viewet sin oppgave!

---

# Hvordan teste view-rendering?

Er avhengig av DOM-en vi initialiserer med el satt til `$(".user")`

Både mye oppsett, tregt og dårlig støttet av mange test-verktøy.

Men vi kan sende inn en "tom ekvivalent", som for eksempel `$("<div></div>")`.
Vi må tilpasse til hva viewet forventer å få som input.

---

# Testing av view-rendering

Vi har lagt til en testhjelper:

    .javascript
    expect(view).toContainInDOM("En string");

---

# Oppgave

    .javascript
    it("should show name when rendered", function(){

    });


---


# Gjennomgang oppgave

    .javascript
    it("should show name when rendered", function(){
        var user = {
            name: "Test Testesen"
        };

        var view = new BEKK.UserView({ user: user, el: $("<div></div>" ) });
        view.render();

        expect(view).toContainInDOM("Test Testesen");
    });


Løsning

* Nevne lagarkitetur med egen render

---

# View.DOM

* `view.DOM()` er en selector-query med `el` som scope, ala `jQuery(selector, context)`
* Løsningen i `toContainInDOM` blir for enkel ettersom den søker etter en string i hele HTML-en
* En intern selector gir også en løs kobling som mulig til DOM og åpner for å flytte rundt og bytte subviews
* Testen er mer en test av rammeverk (vi trenger ikke skrive ny kode for å få denne til å fungere.), men vi har tatt den med for å vise prinsippet med interne selectorer.

---

# Oppgave

it("should contain user name in H1 when rendered", function() {
    var user = {
        name: "Test Testesen"
    };

    var view = new BEKK.UserView({ user: user, el: $("<div></div>" ) });
    view.render();

    // Assert that h1 contains the correct name
    });

---

# Gjennomgang


# Model

* Har ansvar for data og opphenting av denne
  * Kun modeller som har lov til å kommunisere med serveren
* I simple.js følger vi modellstrukturen i backbone.js
  * initialize
  * url
  * attr("prop") attr("prop", set)
  * toJSON

---

# Oppgave

    .javascript
    Test
---

# Gjennomgang oppgave

    .javascript
    Utfylt test

---

# Model

* simple.js implementerer model.fetch med success-callback
* Kaller på url

OBS: Må bruke `jsonp`

---

# Oppgave

    .javascript
    Test

---

# Gjennomgang oppgave

    .javascript
    Utfylt test

* Hastighet
* Avhengig av Twitter-resultat, både på innhold og tidsbruk. 500 ms kræsjer 1 av 3 ganger.
# Testene blir vanskeligere, man må ta hensyn til hastighet.
* Byggeprosessen: må ha et kjørende applikasjon i bygget dersom du skal teste js mot interne applikasjoner


---

# sinon.js

http://sinonjs.org
/
Standalone test spies, stubs and mocks for JavaScript. No dependencies, works with any unit testing framework.

* Fake timers for setTimeout()
* Fake server & XHR
* Finnes mange tilpasninger til rammeverk, f.eks. Jasmine matchers


---

# fake Server

    .javascript
    // Setup
    this.server = sinon.fakeServer.create();

    // Teardown
    this.server.restore();

    // Response
    this.server.respondWith([statusCode, {header: header}, data]);


* "kopiering" av responsen i forrige Oppgave
* registerer ikke endringer i API'et

---

# Oppgave

** OBS: endre til json igjen i simple.js


---

# gjennomgang oppgave

* Oppsett kan gi overhead

---

# testhelper.js

* Gå igjennom fakeServer()
* Fixtures
* Tenke på hvordan denne blir gitt ift oppgave 5

---

# Oppgave

---

# Gjennomgang av oppgave

---

# Events

* Hvordan det fungerer?
* Hvorfor det fungerer? (decoupling)
* Henvise tilbake til callback-oppgaven
* Hva skjer med ekstreme mengder callbacks
* Teste rammeverket vs egen kode? //fetch:finished --> hva viss den endrer seg?

---

# Events

    .javascript
    Eksempel

---

# Oppgave

---

# Gjennomgang av oppgave

---

# Globale events

* Input-feltet gir en event når det er lagt til en ny.
* User-viewet og listen over monologer lytter på denne eventen og enderer sine view etter dette

---

# Oppgave  som ennå ikke er laget


---

# Gjennomgang av oppgave

---

# subviews

* Oppslag innenfor views

---

# Oppgave  som ennå ikke er laget

---

# Gjennomgang av oppgave

---

# Delegering av events

* Oppslag innenfor views

---

# Oppgave som ennå ikke er laget

---

# Gjennomgang av oppgave

---

The END










    </textarea>
    <div id="slideshow"></div>
  </body>
</html>
